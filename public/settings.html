<!doctype html>
<html lang="en" class="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Social Butterflie — Settings</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="./theme.css" />
    <script>
      // Apply theme immediately to prevent flash
      (function() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') {
          document.documentElement.classList.add('dark-mode');
          document.body.classList.add('dark-mode');
        }
      })();
    </script>
  </head>
  <body>
    <div class="app-layout">
      <aside class="nav-rail">
        <a href="./index.html" class="nav-brand">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
            <path d="M16 16 Q10 10, 5 12 Q3 13, 3 15 Q3 17, 5 18 Q10 20, 16 16" />
            <path d="M16 16 Q22 10, 27 12 Q29 13, 29 15 Q29 17, 27 18 Q22 20, 16 16" />
            <path d="M16 17 Q12 20, 8 22 Q6 23, 6 25 Q6 26, 7 27 Q11 28, 16 24" />
            <path d="M16 17 Q20 20, 24 22 Q26 23, 26 25 Q26 26, 25 27 Q21 28, 16 24" />
            <line x1="16" y1="6" x2="16" y2="28" />
            <circle cx="16" cy="6" r="1.5" />
          </svg>
        </a>
        <div class="nav-group">
          <a href="./calendar.html" class="nav-item" aria-label="Calendar">
            <i class="fa-solid fa-calendar-days"></i>
          </a>
          <a href="./build.html" class="nav-item" aria-label="Build Post">
            <i class="fa-solid fa-plus-circle"></i>
          </a>
          <a href="./review.html" class="nav-item" aria-label="Review Queue">
            <i class="fa-regular fa-eye"></i>
          </a>
          <a href="./analytics.html" class="nav-item" aria-label="Analytics">
            <i class="fa-solid fa-chart-line"></i>
          </a>
          <a href="./storage.html" class="nav-item" aria-label="Storage">
            <i class="fa-solid fa-cloud"></i>
          </a>
          <a href="./settings.html" class="nav-item active" aria-label="Settings">
            <i class="fa-solid fa-gear"></i>
          </a>
        </div>
        <a href="./profile.html" class="nav-avatar" aria-label="Profile">
          <i class="fa-solid fa-user"></i>
        </a>
      </aside>

      <div class="main-surface">
        <header class="top-bar glass-panel">
          <div>
            <h1>Workspace Settings</h1>
            <p>Context, team permissions, theme, AI voice, and account connections in one place.</p>
            <div class="section-tabs" aria-label="Settings sections">
              <a class="section-tab" href="#contextSection"><i class="fa-solid fa-compass"></i><span>Context</span></a>
              <a class="section-tab" href="#membersSection"><i class="fa-solid fa-user-shield"></i><span>Members</span></a>
              <a class="section-tab" href="#appearanceSection"><i class="fa-solid fa-palette"></i><span>Appearance</span></a>
              <a class="section-tab" href="#aiSection"><i class="fa-solid fa-wand-magic-sparkles"></i><span>AI</span></a>
              <a class="section-tab" href="#settingsConnections"><i class="fa-solid fa-link"></i><span>Accounts</span></a>
            </div>
          </div>
          <a class="btn btn-secondary" href="./index.html"><i class="fa-solid fa-arrow-left"></i><span>Back to dashboard</span></a>
        </header>

        <div class="space-y-8 mt-8">
          <section id="contextSection" class="glass-panel p-6 space-y-5">
            <div>
              <h2 class="text-lg font-semibold">Workspace Switcher</h2>
              <p class="panel-subtitle">Set active user/workspace context for API calls, approvals, and scheduling.</p>
            </div>
            <div class="form-grid">
              <div>
                <label class="label" for="contextUserId">User ID</label>
                <input id="contextUserId" class="glass-input" placeholder="e.g. demo-user-1" />
              </div>
              <div>
                <label class="label" for="contextUserRole">Role</label>
                <select id="contextUserRole" class="glass-input">
                  <option value="viewer">Viewer</option>
                  <option value="editor">Editor</option>
                  <option value="admin">Admin</option>
                </select>
              </div>
              <div>
                <label class="label" for="workspaceSelect">Workspace</label>
                <div class="flex gap-2">
                  <select id="workspaceSelect" class="glass-input flex-1">
                    <option value="">No workspace</option>
                  </select>
                  <button id="refreshWorkspacesBtn" type="button" class="btn btn-ghost"><i class="fa-solid fa-rotate"></i></button>
                </div>
              </div>
              <div class="flex gap-2">
                <input id="newWorkspaceName" class="glass-input flex-1" placeholder="New workspace name" />
                <button id="createWorkspaceBtn" type="button" class="btn btn-secondary"><i class="fa-solid fa-plus"></i><span>Create</span></button>
              </div>
              <div class="footer-actions">
                <button id="saveContextBtn" class="btn btn-primary" type="button"><i class="fa-solid fa-floppy-disk"></i><span>Save Context</span></button>
              </div>
              <div id="contextStatus" class="text-xs text-muted"></div>
            </div>
          </section>
          <section id="membersSection" class="glass-panel p-6 space-y-5">
            <div>
              <h2 class="text-lg font-semibold">Workspace Members</h2>
              <p class="panel-subtitle">Admins can assign roles used by approval workflow permissions.</p>
            </div>
            <div class="flex gap-2">
              <input id="memberUserId" class="glass-input flex-1" placeholder="member user id" />
              <select id="memberRole" class="glass-input">
                <option value="viewer">Viewer</option>
                <option value="editor">Editor</option>
                <option value="admin">Admin</option>
              </select>
              <button id="addMemberBtn" type="button" class="btn btn-secondary"><i class="fa-solid fa-plus"></i><span>Add/Update</span></button>
            </div>
            <div id="memberStatus" class="text-xs text-muted"></div>
            <div id="memberList" class="space-y-2 text-sm"></div>
          </section>

          <section id="appearanceSection" class="glass-panel p-6 space-y-5">
            <div>
              <h2 class="text-lg font-semibold">Appearance</h2>
              <p class="panel-subtitle">Customize how the app looks and feels.</p>
            </div>
            <div class="form-grid">
              <div>
                <label class="label">Theme Mode</label>
                <div class="theme-toggle-container">
                  <button class="theme-mode-btn" id="lightModeBtn" data-theme="light">
                    <i class="fa-solid fa-sun"></i>
                    <span>Light</span>
                  </button>
                  <button class="theme-mode-btn active" id="darkModeBtn" data-theme="dark">
                    <i class="fa-solid fa-moon"></i>
                    <span>Dark</span>
                  </button>
                </div>
                <p class="text-xs text-muted mt-2">Choose between light and dark theme.</p>
              </div>
            </div>
          </section>

          <section id="aiSection" class="glass-panel p-6 space-y-5">
            <div>
              <h2 class="text-lg font-semibold">AI Preferences</h2>
              <p class="panel-subtitle">Tune the assistant to speak in your brand voice and seed default hashtags.</p>
            </div>
            <form id="aiForm" class="form-grid">
              <div>
                <label class="label" for="brandVoice">Brand voice description</label>
                <textarea id="brandVoice" class="glass-input" rows="3" placeholder="Describe your voice, tone, and brand…"></textarea>
              </div>
              <div>
                <label class="label" for="defaultHashtags">Default hashtags</label>
                <input id="defaultHashtags" class="glass-input" placeholder="#architecture #render #barndominium" />
              </div>
              <div class="footer-actions">
                <button class="btn btn-primary" type="submit"><i class="fa-solid fa-floppy-disk"></i><span>Save changes</span></button>
              </div>
            </form>
          </section>

          <section class="glass-panel p-6 space-y-5" id="settingsConnections">
            <div class="panel-header">
              <h2>Accounts</h2>
            </div>
            <div id="connectionsListSettings" class="space-y-4 text-sm"></div>
          </section>
        </div>
      </div>
    </div>

    <script type="module">
      import { apiGet, apiPost } from '/js/api.js';

      let workspaces = [];
      let members = [];

      function readContext() {
        return {
          userId: (localStorage.getItem('sb_user_id') || 'demo').trim() || 'demo',
          orgId: (localStorage.getItem('sb_org_id') || '').trim(),
          userRole: (localStorage.getItem('sb_user_role') || 'editor').trim() || 'editor'
        };
      }

      function writeContext({ userId, orgId, userRole }) {
        if (userId) localStorage.setItem('sb_user_id', userId);
        else localStorage.removeItem('sb_user_id');
        if (orgId) localStorage.setItem('sb_org_id', orgId);
        else localStorage.removeItem('sb_org_id');
        if (userRole) localStorage.setItem('sb_user_role', userRole);
        else localStorage.removeItem('sb_user_role');
      }

      function renderContextStatus() {
        const status = document.getElementById('contextStatus');
        if (!status) return;
        const ctx = readContext();
        const ws = workspaces.find(w => w.id === ctx.orgId);
        status.innerHTML = `Active user: <strong>${ctx.userId}</strong> &middot; Role: <strong>${ctx.userRole}</strong>${ctx.orgId ? ` &middot; Workspace: <strong>${ws ? ws.name : ctx.orgId}</strong>` : ''}`;
      }

      async function loadWorkspaces() {
        const select = document.getElementById('workspaceSelect');
        if (!select) return;
        const ctx = readContext();
        const response = await apiGet('/workspaces');
        workspaces = Array.isArray(response.items) ? response.items : [];
        select.innerHTML = '<option value="">No workspace</option>' + workspaces.map(w => `<option value="${w.id}">${w.name}</option>`).join('');
        if (ctx.orgId) select.value = ctx.orgId;
        renderContextStatus();
      }

      function renderMembers() {
        const list = document.getElementById('memberList');
        if (!list) return;
        const ctx = readContext();
        if (!ctx.orgId) {
          list.innerHTML = '<div class="text-muted text-xs">Select a workspace to manage members.</div>';
          return;
        }
        if (!members.length) {
          list.innerHTML = '<div class="text-muted text-xs">No members yet.</div>';
          return;
        }
        list.innerHTML = members.map(m => `
          <div class="caption-card flex items-center justify-between">
            <span>${m.user_id}</span>
            <span class="badge">${m.role}</span>
          </div>
        `).join('');
      }

      async function loadMembers() {
        const ctx = readContext();
        if (!ctx.orgId) {
          members = [];
          renderMembers();
          return;
        }
        try {
          const res = await apiGet('/workspace/members');
          members = Array.isArray(res.items) ? res.items : [];
          renderMembers();
          document.getElementById('memberStatus').textContent = '';
        } catch (e) {
          document.getElementById('memberStatus').textContent = `Members unavailable: ${e.message}`;
          members = [];
          renderMembers();
        }
      }

      async function upsertMember() {
        const userId = (document.getElementById('memberUserId').value || '').trim();
        const role = (document.getElementById('memberRole').value || 'viewer').trim();
        if (!userId) return;
        await apiPost('/workspace/members', { userId, role });
        document.getElementById('memberUserId').value = '';
        await loadMembers();
      }

      async function createWorkspace() {
        const input = document.getElementById('newWorkspaceName');
        const name = input?.value?.trim();
        if (!name) return;
        const created = await apiPost('/workspaces', { name });
        input.value = '';
        await loadWorkspaces();
        document.getElementById('workspaceSelect').value = created.id;
      }

      function renderConnectionsPanel(conns) {
        const list = document.getElementById('connectionsListSettings');
        if (!list) return;
        const providers = [
          { key: 'facebook', label: 'Facebook + IG', icon: 'fa-facebook' },
          { key: 'youtube', label: 'YouTube', icon: 'fa-youtube' },
          { key: 'tiktok', label: 'TikTok', icon: 'fa-tiktok' }
        ];
        const connected = new Map();
        (conns||[]).forEach(c => connected.set(c.provider, c));
        list.innerHTML = providers.map(p => {
          const active = connected.has(p.key);
          const status = active ? '<span class="badge" style="background:rgba(34,197,94,0.25);border:1px solid rgba(34,197,94,0.4);color:#bbf7d0">Connected</span>' : '<span class="badge" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:var(--text-muted)">Not linked</span>';
          const actionBtn = active ? `<button class=\"btn btn-ghost\" data-disconnect=\"${p.key}\"><i class=\"fa-solid fa-link-slash\"></i><span>Disconnect</span></button>` : `<button class=\"btn btn-secondary\" data-connect=\"${p.key}\"><i class=\"fa-brands ${p.icon}\"></i><span>Link ${p.label}</span></button>`;
          return `
            <div class=\"caption-card\" data-provider-card=\"${p.key}\">
              <div class=\"flex items-center justify-between gap-3\">
                <div class=\"text-sm font-medium flex items-center gap-2\"><i class=\"fa-brands ${p.icon}\"></i><span>${p.label}</span></div>
                ${status}
              </div>
              <footer>${actionBtn}</footer>
            </div>
          `;
        }).join('');
        list.querySelectorAll('[data-connect]').forEach(btn => btn.addEventListener('click', () => connect(btn.getAttribute('data-connect'))));
        list.querySelectorAll('[data-disconnect]').forEach(btn => btn.addEventListener('click', async () => {
          if (!confirm('Disconnect this account?')) return;
          await apiPost('/disconnect', { provider: btn.getAttribute('data-disconnect') });
          const refreshed = await apiGet('/connections');
          renderConnectionsPanel(refreshed);
        }));
      }

      // Theme Toggle
      function initThemeToggle() {
        const lightBtn = document.getElementById('lightModeBtn');
        const darkBtn = document.getElementById('darkModeBtn');
        const body = document.body;
        
        // Check for saved theme preference or default to light mode
        const savedTheme = localStorage.getItem('theme') || 'light';
        
        function setTheme(theme) {
          if (theme === 'dark') {
            body.classList.add('dark-mode');
            darkBtn.classList.add('active');
            lightBtn.classList.remove('active');
          } else {
            body.classList.remove('dark-mode');
            lightBtn.classList.add('active');
            darkBtn.classList.remove('active');
          }
          localStorage.setItem('theme', theme);
        }
        
        // Set initial theme
        setTheme(savedTheme);
        
        // Add click handlers
        lightBtn.addEventListener('click', () => setTheme('light'));
        darkBtn.addEventListener('click', () => setTheme('dark'));
      }

      async function load() {
        const ctx = readContext();
        const userEl = document.getElementById('contextUserId');
        if (userEl) userEl.value = ctx.userId;
        const roleEl = document.getElementById('contextUserRole');
        if (roleEl) roleEl.value = ctx.userRole;
        await loadWorkspaces();
        const prefs = await apiGet('/prefs');
        document.getElementById('brandVoice').value = prefs.brandVoice || '';
        document.getElementById('defaultHashtags').value = (prefs.defaultHashtags || []).join(' ');

        const conns = await apiGet('/connections');
        renderConnectionsPanel(conns);
        
        initThemeToggle();
        await loadMembers();
      }

      window.addEventListener('connections:refresh', async () => {
        try { const conns = await apiGet('/connections'); renderConnectionsPanel(conns); } catch(e) {}
      });

      document.getElementById('aiForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await apiPost('/prefs', {
          brandVoice: document.getElementById('brandVoice').value,
          defaultHashtags: document.getElementById('defaultHashtags').value.split(/\s+/).filter(Boolean)
        });
        alert('Saved');
      });

      document.getElementById('saveContextBtn').addEventListener('click', async () => {
        const userId = (document.getElementById('contextUserId').value || '').trim() || 'demo';
        const orgId = (document.getElementById('workspaceSelect').value || '').trim();
        const userRole = (document.getElementById('contextUserRole').value || 'editor').trim();
        writeContext({ userId, orgId, userRole });
        renderContextStatus();
        await load();
      });

      document.getElementById('createWorkspaceBtn').addEventListener('click', async () => {
        try {
          await createWorkspace();
        } catch (e) {
          alert('Failed to create workspace: ' + e.message);
        }
      });

      document.getElementById('refreshWorkspacesBtn').addEventListener('click', async () => {
        try {
          await loadWorkspaces();
          await loadMembers();
        } catch (e) {
          alert('Failed to refresh workspaces: ' + e.message);
        }
      });

      document.getElementById('addMemberBtn').addEventListener('click', async () => {
        try {
          await upsertMember();
        } catch (e) {
          alert('Failed to upsert member: ' + e.message);
        }
      });

      load();
    </script>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-nav">
      <a href="./index.html" class="nav-brand">
        <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
          <path d="M16 16 Q10 10, 5 12 Q3 13, 3 15 Q3 17, 5 18 Q10 20, 16 16" />
          <path d="M16 16 Q22 10, 27 12 Q29 13, 29 15 Q29 17, 27 18 Q22 20, 16 16" />
          <path d="M16 17 Q12 20, 8 22 Q6 23, 6 25 Q6 26, 7 27 Q11 28, 16 24" />
          <path d="M16 17 Q20 20, 24 22 Q26 23, 26 25 Q26 26, 25 27 Q21 28, 16 24" />
          <line x1="16" y1="6" x2="16" y2="28" />
          <circle cx="16" cy="6" r="1.5" />
        </svg>
      </a>
      <div class="nav-group">
        <a href="./calendar.html" class="nav-item" aria-label="Calendar"><i class="fa-solid fa-calendar-days"></i></a>
        <a href="./build.html" class="nav-item" aria-label="Build Post"><i class="fa-solid fa-plus-circle"></i></a>
        <a href="./review.html" class="nav-item" aria-label="Review Queue"><i class="fa-regular fa-eye"></i></a>
        <a href="./analytics.html" class="nav-item" aria-label="Analytics"><i class="fa-solid fa-chart-line"></i></a>
        <a href="./storage.html" class="nav-item" aria-label="Storage"><i class="fa-solid fa-cloud"></i></a>
        <a href="./settings.html" class="nav-item active" aria-label="Settings"><i class="fa-solid fa-gear"></i></a>
      </div>
      <a href="./profile.html" class="nav-avatar" aria-label="Profile"><i class="fa-solid fa-user"></i></a>
    </nav>
  </body>
</html>
